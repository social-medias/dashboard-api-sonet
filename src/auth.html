<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image-Inspired Auth Panel</title>
  <!-- Load Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Configure Tailwind to use the custom color palette (vibrant purples) -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            // Custom Palette (Based on the image's vibrant purples)
            'primary': '#8b5cf6',   // Vibrant Violet (for button and key elements)
            'secondary': '#a78bfa', // Lighter Violet
            'success': '#10b981',
            'danger': '#ef4444',
            'background-light': '#f9fafb', // Lightest gray for body background
            'warning': '#f59e0b',
            'card-bg': '#ffffff',
            'illustration-dark': '#6d28d9', // Darker purple for illustration area (now unused)
            'illustration-light': '#a78bfa', // Lighter violet for gradient (now unused)
          },
          boxShadow: {
            // Soft, wide shadow like the image
            'main-container': '0 25px 50px -12px rgba(0, 0, 0, 0.15)',
            'card-lift': '0 4px 10px rgba(0, 0, 0, 0.05)',
          }
        }
      }
    }
  </script>
  <style>
    /* Apply the custom light background color to the body and use smooth font rendering */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f9fafb;
      /* background-light */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Custom Primary Button Styling (Inverted: White background, Primary text/border) */
    .btn-primary-image {
      background-color: #ffffff;
      /* White background */
      color: #8b5cf6;
      /* Primary text color (Purple) */
      border: 2px solid #8b5cf6;
      /* Primary border color */
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
      /* Very subtle shadow for lift */
    }

    .btn-primary-image:hover {
      background-color: #8b5cf6;
      /* Primary fill on hover */
      color: #ffffff;
      /* White text on hover */
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.8);
    }

    /* Subtle input focus ring */
    input:focus {
      --tw-ring-shadow: 0 0 0 1px var(--color-primary);
      box-shadow: var(--tw-ring-shadow);
      border-color: var(--color-primary);
      outline: none;
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center p-6 sm:p-10">

  <!-- Loading Spinner (Initial state) -->
  <div id="loading-view" class="flex flex-col items-center justify-center p-8 bg-card-bg rounded-xl shadow-md">
    <div
      class="animate-spin rounded-full h-12 w-12 border-4 border-t-primary border-r-primary border-b-primary border-l-secondary">
    </div>
    <p class="mt-4 text-gray-600 font-medium">Authenticating User...</p>
  </div>

  <!-- 1. Authentication View (Login/Signup) - Single Column Layout -->
  <!-- max-w-lg (512px) for a focused form appearance -->
  <div id="auth-view"
    class="hidden w-full max-w-lg bg-card-bg rounded-3xl shadow-main-container transition-all duration-500 transform scale-100 opacity-100 max-h-[95vh] overflow-y-auto">

    <!-- Form Content -->
    <!-- This div now takes the full space of the auth card -->
    <div class="p-8 md:p-14 space-y-8 flex flex-col justify-center">
      <!-- Logo/App Name -->
      <div class="flex items-center text-lg font-bold text-gray-800">
        <!-- Icon: Replaced with Lucide Zap/Thunder icon SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary mr-2" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
        </svg>
        no ask.me
      </div>

      <!-- Welcome Text -->
      <div>
        <h1 class="text-5xl font-extrabold text-gray-900 mb-2 leading-snug">
          Holla, <br> Welcome Back
        </h1>
        <p class="text-base text-gray-500">
          Hey, welcome back to your special place
        </p>
      </div>

      <form id="auth-form" class="space-y-6">
        <div>
          <!-- Email Input (No label, using placeholder as per image style) -->
          <input type="email" id="email" required placeholder="stanley@gmail.com"
            class="w-full px-4 py-3 border border-gray-200 rounded-lg transition duration-150 ease-in-out placeholder-gray-400">
        </div>

        <div>
          <!-- Password Input (No label, using placeholder as per image style) -->
          <input type="password" id="password" required placeholder="••••••••"
            class="w-full px-4 py-3 border border-gray-200 rounded-lg transition duration-150 ease-in-out placeholder-gray-400">
        </div>

        <div class="flex justify-between items-center text-sm">
          <label class="inline-flex items-center">
            <!-- Checkbox matching image style -->
            <input type="checkbox" checked
              class="form-checkbox h-4 w-4 text-primary rounded border-gray-300 focus:ring-primary">
            <span class="ml-2 text-gray-600">Remember me</span>
          </label>
          <a href="#" class="text-gray-500 hover:text-primary font-medium">Forgot Password?</a>
        </div>

        <!-- Error Message Box -->
        <div id="auth-error-message"
          class="hidden p-3 text-sm text-danger bg-red-50 rounded-lg border border-danger font-medium" role="alert">
          Authentication failed.
        </div>

        <div class="pt-2">
          <!-- Primary Button matching image style - NOW INVERTED -->
          <button type="submit" id="auth-button"
            class="w-full flex justify-center items-center py-3.5 px-4 rounded-xl text-lg font-bold btn-primary-image">
            Sign In
          </button>
        </div>
      </form>

      <div class="mt-4 text-left text-sm">
        <span class="text-gray-500">Don't have an account? </span>
        <button id="toggle-auth-mode" class="text-primary hover:text-secondary font-semibold">
          Sign Up
        </button>
      </div>
    </div>
  </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      onAuthStateChanged,
      signInWithCustomToken,
      signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const __firebase_config = {
      apiKey: "AIzaSyArb4dHgtmNvhiyc7ssRdYeo0Es9PSgR3g",
      authDomain: "api-sonet.firebaseapp.com",
      projectId: "api-sonet",
      storageBucket: "api-sonet.firebasestorage.app",
      messagingSenderId: "659857500960",
      appId: "1:659857500960:web:1fa07fc440d055d3f68545"
    };

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Initialize Firebase
    let app;
    let auth;
    let db;

    try {
      if (Object.keys(firebaseConfig).length > 0) {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        // Set debug logging for Firestore/Auth to see potential errors
        setLogLevel('Debug');
      } else {
        console.error("Firebase configuration is missing or empty.");
      }
    } catch (error) {
      console.error("Failed to initialize Firebase:", error);
    }

    // DOM Elements
    const loadingView = document.getElementById('loading-view');
    const authView = document.getElementById('auth-view');
    const adminView = document.getElementById('admin-view');
    const authForm = document.getElementById('auth-form');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const authButton = document.getElementById('auth-button');
    const errorMessage = document.getElementById('auth-error-message');
    const toggleAuthModeButton = document.getElementById('toggle-auth-mode');
    const signOutButton = document.getElementById('sign-out-button');
    const userIdDisplay = document.getElementById('user-id-display');
    const userEmailDisplay = document.getElementById('user-email-display');

    let isLoginMode = true;

    // --- UI State Management Functions ---

    /** Shows the loading view and hides others. */
    function showLoading() {
      loadingView.classList.remove('hidden');
      authView.classList.add('hidden');
      adminView.classList.add('hidden');
    }

    /** Shows the authentication view (Login/Register). */
    function showAuthView() {
      loadingView.classList.add('hidden');
      adminView.classList.add('hidden');
      authView.classList.remove('hidden');

      // Update UI for current mode
      const welcomeText = document.querySelector('#auth-view h1');
      const subText = document.querySelector('#auth-view p.text-gray-500');
      const registerLinkText = document.querySelector('#toggle-auth-mode');

      if (isLoginMode) {
        welcomeText.innerHTML = 'Holla, <br> Welcome Back';
        subText.textContent = 'Hey, welcome back to your special place';
        authButton.textContent = 'Sign In';
        registerLinkText.innerHTML = 'Sign Up';
      } else {
        welcomeText.innerHTML = 'Create Your <br> Secure Account';
        subText.textContent = 'Join us and start managing your experience.';
        authButton.textContent = 'Register Account';
        registerLinkText.innerHTML = 'Sign In';
      }
    }

    /** Shows the admin panel view. */
    function showAdminView(user) {
      loadingView.classList.add('hidden');
      authView.classList.add('hidden');
      adminView.classList.remove('hidden');

      window.location.href = 'index.html';

      // Update user info display
      userIdDisplay.textContent = user.uid;
      userEmailDisplay.textContent = user.email || 'N/A (Signed in anonymously)';
    }

    /** Displays an authentication error message. */
    function displayError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
    }

    /** Clears the authentication error message. */
    function clearError() {
      errorMessage.classList.add('hidden');
      errorMessage.textContent = '';
    }

    // --- Authentication Handlers ---

    /** Toggles between Login and Register modes. */
    toggleAuthModeButton.addEventListener('click', (e) => {
      e.preventDefault();
      isLoginMode = !isLoginMode;
      clearError();
      showAuthView(); // Re-render the view with new mode settings
    });

    /** Handles the form submission for both Login and Registration. */
    authForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearError();

      const email = emailInput.value;
      const password = passwordInput.value;

      if (!email || !password) {
        displayError("Please enter both email and password.");
        return;
      }

      try {
        // Determine spinner color based on button's current text color (primary purple)
        const spinnerColor = 'text-primary';
        const loadingText = isLoginMode ? 'Signing In...' : 'Registering...';

        authButton.disabled = true;
        authButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-6 w-6 ${spinnerColor}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    ${loadingText}`;


        if (isLoginMode) {
          await signInWithEmailAndPassword(auth, email, password);
        } else {
          await createUserWithEmailAndPassword(auth, email, password);
        }
        // Auth state observer handles the UI update on success
      } catch (error) {
        console.error("Auth Error:", error);
        let message = "An unknown authentication error occurred.";
        // Map common Firebase error codes to friendly messages
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
          message = "Invalid email or password.";
        } else if (error.code === 'auth/email-already-in-use') {
          message = "This email is already registered. Try signing in.";
        } else if (error.code === 'auth/weak-password') {
          message = "Password should be at least 6 characters.";
        } else if (error.code === 'auth/invalid-email') {
          message = "Invalid email format.";
        }
        displayError(message);

        authButton.disabled = false;
        authButton.textContent = isLoginMode ? 'Sign In' : 'Register Account';
      }
    });

    /** Handles the sign out process. */
    // signOutButton.addEventListener('click', async () => {
    //   try {
    //     await signOut(auth);
    //   } catch (error) {
    //     console.error("Sign Out Error:", error);
    //     // In a real app, you might show a toast notification here
    //   }
    // });

    // --- Firebase Auth State Observer ---

    /** This runs once on load and whenever the user's sign-in state changes. */
    if (auth) {
      // First, try to sign in using the provided custom token (Canvas environment auth)
      if (initialAuthToken) {
        signInWithCustomToken(auth, initialAuthToken).catch(e => {
          console.warn("Custom token sign-in failed, proceeding with anonymous/email auth check.", e);
          // If custom token fails, proceed to onAuthStateChanged which will handle the final state.
        });
      } else {
        // If no custom token, sign in anonymously to meet security rules for initial data access
        signInAnonymously(auth).catch(e => {
          console.error("Anonymous sign-in failed:", e);
        });
      }

      // The main state listener
      onAuthStateChanged(auth, (user) => {
        if (user && user.email) {
          // User is signed in with email/password
          console.log("User authenticated:", user.uid);
          showAdminView(user);
          clearError();

          // Reset button state
          authButton.disabled = false;
          authButton.textContent = isLoginMode ? 'Sign In' : 'Register Account';

        } else if (user && !user.email) {
          // User is signed in anonymously (from __initial_auth_token fallback)
          // If they are anonymous, push them to the login screen since they need a proper account to access the "Admin Panel"
          console.log("Anonymous user detected. Redirecting to login.");
          showAuthView();
        }
        else {
          // User is signed out.
          console.log("User signed out or not authenticated.");
          showAuthView();
        }
      });
    } else {
      // If Firebase failed to initialize, show the login view and an error
      loadingView.classList.add('hidden');
      authView.classList.remove('hidden');
      displayError("Application Error: Firebase configuration failed to load. Check console for details.");
    }

    // Start by showing the loading state while auth checks run
    showLoading();

  </script>
</body>

</html>